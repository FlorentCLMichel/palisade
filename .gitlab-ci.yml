stages:
- setup
- build
- unit_test
- benchmark
- docs

variables:
  GIT_SUBMODULE_STRATEGY: recursive

before_script:
# - module load gcc/7.3.0
# - module load cmake/3.9.4
# - apt-get install --yes cmake
- whoami
- export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$(pwd)/build/third-party/lib:$(pwd)/build/lib
# - export DO_CI="OFF"

default_build:
  stage: build
  only:
    refs: 
      - master
      - merge_requests
  cache:
    key: default-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

noflag_mb4_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: noflag-mb4-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DMATHBACKEND=4 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_mb2_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: debug-mb2-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DMATHBACKEND=2 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_mb4_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: debug-mb4-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DMATHBACKEND=4 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []


ntl_mb6_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: ntl-mb6-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_NTL=Y -DMATHBACKEND=6 ..
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_mb2_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: tcm-mb2-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_TCM=Y -DMATHBACKEND=2 ..
  - make tcm
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_mb4_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: tcm-mb4-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_TCM=Y -DMATHBACKEND=4 ..
  - make tcm
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_ntl_mb6_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: tcm-ntl-mb6-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_NTL=Y -DWITH_TCM=Y -DMATHBACKEND=6 ..
  - make tcm
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_tcm_ntl_mb6_build:
  stage: build
  only:
    refs:
      - master
      - merge_requests
  cache:
    key: tcm-ntl-mb6-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DWITH_NTL=Y -DWITH_TCM=Y -DMATHBACKEND=6 ..
  - make tcm
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

default_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build

noflag_mb4_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build

debug_mb2_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build

debug_mb4_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build

ntl_mb6_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build

tcm_mb2_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build

tcm_mb4_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build

tcm_ntl_mb6_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build

debug_tcm_ntl_mb6_test_abe:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build

default_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build

noflag_mb4_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build

debug_mb2_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build

debug_mb4_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build

ntl_mb6_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build

tcm_mb2_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build

tcm_mb4_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build

tcm_ntl_mb6_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build

debug_tcm_ntl_mb6_test_core:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build

default_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build

noflag_mb4_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build

debug_mb2_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build

debug_mb4_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build

ntl_mb6_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build

tcm_mb2_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build

tcm_mb4_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build

tcm_ntl_mb6_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build

debug_tcm_ntl_mb6_test_pke:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build

default_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build

noflag_mb4_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build

debug_mb2_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build

debug_mb4_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build

ntl_mb6_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build

tcm_mb2_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build

tcm_mb4_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build

tcm_ntl_mb6_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build

debug_tcm_ntl_mb6_test_signature:
  stage: unit_test
  only:
    refs:
      - master
      - merge_requests
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build

# coverage:
#   stage: docs
#   script:
#   - make -j $(nproc) all COVERAGE=1
#   - make -j $(nproc) testall COVERAGE=1
#   - mkdir -p doc/coverage
#   - gcovr -j $(nproc) --verbose -r . --filter src/[^/]+/lib/* --filter src/* --html --html-details -o doc/coverage/index.html --print-summary
#   allow_failure: true
#   dependencies:
#   - default_build
#   artifacts:
#     paths:
#     - doc/coverage
#     expire_in: 3 hours

benchmark_basic:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/basic_test --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

# benchmark_crypto:
#   stage: benchmark
#   script:
#   - build/bin/benchmark/Crypto --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
#   dependencies:
#   - build
#   artifacts:
#     paths:
#       - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
#     expire_in: 1 month

benchmark_encoding:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/Encoding --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_integermath:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/IntegerMath --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_lattice:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/Lattice --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_nbtheory:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/NbTheory --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

# benchmark_she:
#   stage: benchmark
#   script:
#   - build/bin/benchmark/SHE --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
#   dependencies:
#   - build
#   artifacts:
#     paths:
#       - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
#     expire_in: 1 month

benchmark_vectormath:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/VectorMath --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_lib:
  stage: benchmark
  only:
    refs:
      - master
      - merge_requests
  script:
  - build/bin/benchmark/lib-benchmark --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

# Manual Trigger CI

default_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: default_manual-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

noflag_mb4_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: noflag-mb4-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DMATHBACKEND=4 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_mb2_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: debug-mb2-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DMATHBACKEND=2 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_mb4_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: debug-mb4-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DMATHBACKEND=4 ..
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []


ntl_mb6_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: ntl-mb6-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_NTL=Y -DMATHBACKEND=6 ..
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_mb2_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: tcm-mb2-build-libs
    paths:
      - build
  script:
  - whoami
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_TCM=Y -DMATHBACKEND=2 ..
  - make tcm
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_mb4_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: tcm-mb4-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_TCM=Y -DMATHBACKEND=4 ..
  - make tcm
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

tcm_ntl_mb6_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: tcm-ntl-mb6-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DWITH_NTL=Y -DWITH_TCM=Y -DMATHBACKEND=6 ..
  - make tcm
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

debug_tcm_ntl_mb6_build_manual:
  stage: build
  only:
    variables:
      - $DO_CI
  cache:
    key: tcm-ntl-mb6-build-libs
    paths:
      - build
  script:
  - mkdir -p build
  - cd build
  - CC=gcc CXX=g++ cmake -DCMAKE_BUILD_TYPE=Debug -DWITH_NTL=Y -DWITH_TCM=Y -DMATHBACKEND=6 ..
  - make tcm
  - make gmp_unpack
  - make ntl_unpack_nowizard
  - make -j $(nproc) gmp_all
  - make -j $(nproc) ntl_all
  - make -j $(nproc) all
  artifacts:
    paths:
    - build/third-party/lib
    - build/lib
    - build/unittest
    - build/bin/benchmark
    expire_in: 1 day
  dependencies: []

default_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build_manual

noflag_mb4_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build_manual

debug_mb2_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build_manual

debug_mb4_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build_manual

ntl_mb6_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build_manual

tcm_mb2_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build_manual

tcm_mb4_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build_manual

tcm_ntl_mb6_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build_manual

debug_tcm_ntl_mb6_test_abe_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/abe_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build_manual

default_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build_manual

noflag_mb4_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build_manual

debug_mb2_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build_manual

debug_mb4_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build_manual

ntl_mb6_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build_manual

tcm_mb2_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build_manual

tcm_mb4_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build_manual

tcm_ntl_mb6_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build_manual

debug_tcm_ntl_mb6_test_core_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/core_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build_manual

default_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build_manual

noflag_mb4_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build_manual

debug_mb2_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build_manual

debug_mb4_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build_manual

ntl_mb6_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build_manual

tcm_mb2_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build_manual

tcm_mb4_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build_manual

tcm_ntl_mb6_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build_manual

debug_tcm_ntl_mb6_test_pke_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/pke_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build_manual

default_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - default_build_manual

noflag_mb4_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - noflag_mb4_build_manual

debug_mb2_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb2_build_manual

debug_mb4_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_mb4_build_manual

ntl_mb6_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - ntl_mb6_build_manual

tcm_mb2_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb2_build_manual

tcm_mb4_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_mb4_build_manual

tcm_ntl_mb6_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - tcm_ntl_mb6_build_manual

debug_tcm_ntl_mb6_test_signature_manual:
  stage: unit_test
  only:
    variables:
      - $DO_CI
  script:
  - pwd
  - echo $LD_LIBRARY_PATH
  - build/unittest/signature_tests --gtest_output=xml
  artifacts:
    paths:
    - test_detail.xml
    expire_in: 2 days
  dependencies:
  - debug_tcm_ntl_mb6_build_manual

# coverage:
#   stage: docs
#   script:
#   - make -j $(nproc) all COVERAGE=1
#   - make -j $(nproc) testall COVERAGE=1
#   - mkdir -p doc/coverage
#   - gcovr -j $(nproc) --verbose -r . --filter src/[^/]+/lib/* --filter src/* --html --html-details -o doc/coverage/index.html --print-summary
#   allow_failure: true
#   dependencies:
#   - default_build
#   artifacts:
#     paths:
#     - doc/coverage
#     expire_in: 3 hours

benchmark_basic_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/basic_test --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

# benchmark_crypto:
#   stage: benchmark
#   script:
#   - build/bin/benchmark/Crypto --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
#   dependencies:
#   - build
#   artifacts:
#     paths:
#       - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
#     expire_in: 1 month

benchmark_encoding_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/Encoding --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_integermath_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/IntegerMath --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_lattice_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/Lattice --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_nbtheory_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/NbTheory --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

# benchmark_she:
#   stage: benchmark
#   script:
#   - build/bin/benchmark/SHE --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
#   dependencies:
#   - build
#   artifacts:
#     paths:
#       - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
#     expire_in: 1 month

benchmark_vectormath_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/VectorMath --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month

benchmark_lib_manual:
  stage: benchmark
  only:
    variables:
      - $DO_CI
  script:
  - build/bin/benchmark/lib-benchmark --benchmark_out="${CI_JOB_NAME}_${CI_COMMIT_SHA}" --benchmark_out_format=csv
  dependencies:
  - tcm_mb2_build_manual
  artifacts:
    paths:
      - "${CI_JOB_NAME}_${CI_COMMIT_SHA}"
    expire_in: 1 month
